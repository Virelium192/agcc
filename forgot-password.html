<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Agriclimate Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'green-earth': '#2D7D32',
                        'brown-soil': '#8D6E63',
                        'blue-sky': '#1976D2',
                        'yellow-sun': '#FBC02D',
                        'gold': '#FFD700',
                        'emerald': '#10B981',
                        'sapphire': '#3B82F6'
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif']
                    },
                    animation: {
                        'gradient': 'gradient 15s ease infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slide-up 0.5s ease-out',
                        'fade-in': 'fade-in 0.6s ease-out'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        .premium-gradient {
            background: linear-gradient(135deg, #2D7D32 0%, #1976D2 25%, #5D5CDE 50%, #FBC02D 75%, #10B981 100%);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes slide-up {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .dark .glass-morphism {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .premium-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.8) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(45, 125, 50, 0.1);
            box-shadow: 0 16px 64px rgba(0, 0, 0, 0.05), 0 8px 32px rgba(45, 125, 50, 0.1);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .dark .premium-card {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-input {
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(45, 125, 50, 0.1);
        }
        
        .dark .form-input {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(45, 125, 50, 0.15);
            border-color: #2D7D32;
            background: rgba(255, 255, 255, 1);
        }
        
        .dark .form-input:focus {
            background: rgba(0, 0, 0, 0.9);
            border-color: #10B981;
        }
        
        .premium-button {
            background: linear-gradient(135deg, #2D7D32, #10B981);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            overflow: hidden;
        }
        
        .premium-button:hover {
            background: linear-gradient(135deg, #1976D2, #3B82F6);
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(45, 125, 50, 0.4);
        }
        
        .premium-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body class="min-h-screen premium-gradient font-inter relative overflow-x-hidden">
    <!-- Header -->
    <header class="fixed top-0 w-full z-50 glass-morphism">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-green-earth to-emerald rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-seedling text-white text-xl"></i>
                    </div>
                    <div>
                        <div class="font-bold text-xl text-white">Agriclimate Connect</div>
                        <div class="text-xs text-white/80">Smart Agriculture Platform</div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="toggleDarkMode()" class="p-3 hover:bg-white/10 rounded-full transition-colors">
                        <i class="fas fa-moon text-white dark:hidden"></i>
                        <i class="fas fa-sun text-white hidden dark:block"></i>
                    </button>
                    <a href="/login.html" class="text-white/90 hover:text-white text-sm font-medium transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Login
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-16 relative min-h-screen flex items-center justify-center">
        <div class="max-w-md mx-auto px-4 sm:px-6 lg:px-8 w-full">
            <!-- Reset Password Form -->
            <div id="reset-form" class="premium-card p-10 rounded-3xl animate-slide-up">
                <!-- Logo and Title -->
                <div class="text-center mb-10">
                    <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-yellow-sun to-gold rounded-full flex items-center justify-center shadow-lg animate-float">
                        <i class="fas fa-key text-white text-2xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Reset Password</h1>
                    <p class="text-gray-600 dark:text-gray-300">Enter your email to receive password reset instructions</p>
                </div>

                <!-- Reset Form -->
                <form id="forgot-password-form" class="space-y-6" novalidate>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Email Address</label>
                        <div class="relative">
                            <input type="email" id="email" name="email" required
                                   class="form-input w-full px-6 py-4 pl-12 rounded-xl text-lg font-medium"
                                   placeholder="your.email@example.com">
                            <i class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <div id="email-error" class="text-sm text-red-500 mt-1 hidden"></div>
                        <p class="text-sm text-gray-500 mt-2">We'll send password reset instructions to this email address</p>
                    </div>

                    <button type="submit" id="reset-btn" 
                            class="premium-button w-full text-white px-8 py-4 rounded-xl text-lg font-semibold">
                        <span id="reset-btn-text">
                            <i class="fas fa-paper-plane mr-3"></i>Send Reset Instructions
                        </span>
                        <span id="reset-btn-loading" class="hidden">
                            <i class="fas fa-spinner fa-spin mr-3"></i>Sending...
                        </span>
                    </button>
                </form>

                <!-- Back to Login -->
                <div class="mt-8 text-center">
                    <p class="text-gray-600 dark:text-gray-300">
                        Remember your password? 
                        <a href="/login.html" class="text-green-earth hover:text-emerald font-semibold transition-colors">
                            Sign in here
                        </a>
                    </p>
                </div>
            </div>

            <!-- Success Message -->
            <div id="success-message" class="hidden premium-card p-10 rounded-3xl text-center animate-slide-up">
                <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-green-earth to-emerald rounded-full flex items-center justify-center shadow-lg">
                    <i class="fas fa-check text-white text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">Check Your Email</h1>
                <p class="text-lg text-gray-600 dark:text-gray-300 mb-8">
                    We've sent password reset instructions to <strong id="sent-email"></strong>
                </p>
                
                <div class="space-y-4 text-sm text-gray-500 dark:text-gray-400">
                    <p>📧 Check your inbox (and spam folder)</p>
                    <p>🔗 Click the reset link in the email</p>
                    <p>🔒 Create a new secure password</p>
                </div>
                
                <div class="mt-8 space-y-4">
                    <button onclick="resendResetEmail()" 
                            class="premium-button w-full text-white px-8 py-4 rounded-xl text-lg font-semibold">
                        <i class="fas fa-refresh mr-3"></i>Resend Email
                    </button>
                    <a href="/login.html" 
                       class="block w-full text-center border-2 border-white/30 text-white px-8 py-4 rounded-xl text-lg font-semibold hover:bg-white/10 transition-all">
                        <i class="fas fa-arrow-left mr-3"></i>Back to Login
                    </a>
                </div>
            </div>

            <!-- Password Reset Form (for when user clicks reset link) -->
            <div id="new-password-form" class="hidden premium-card p-10 rounded-3xl animate-slide-up">
                <div class="text-center mb-10">
                    <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-sapphire to-blue-sky rounded-full flex items-center justify-center shadow-lg animate-float">
                        <i class="fas fa-lock text-white text-2xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Create New Password</h1>
                    <p class="text-gray-600 dark:text-gray-300">Enter your new secure password</p>
                </div>

                <form id="update-password-form" class="space-y-6" novalidate>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">New Password</label>
                        <div class="relative">
                            <input type="password" id="new_password" name="new_password" required
                                   class="form-input w-full px-6 py-4 pl-12 pr-14 rounded-xl text-lg font-medium"
                                   placeholder="Enter new password">
                            <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <button type="button" onclick="togglePasswordVisibility('new_password')" 
                                    class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye" id="new_password-eye"></i>
                            </button>
                        </div>
                        <div id="password-strength" class="mt-3">
                            <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div id="strength-bar" class="h-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div id="strength-text" class="text-sm mt-2"></div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Confirm New Password</label>
                        <div class="relative">
                            <input type="password" id="confirm_password" name="confirm_password" required
                                   class="form-input w-full px-6 py-4 pl-12 pr-14 rounded-xl text-lg font-medium"
                                   placeholder="Confirm new password">
                            <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <button type="button" onclick="togglePasswordVisibility('confirm_password')" 
                                    class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye" id="confirm_password-eye"></i>
                            </button>
                        </div>
                        <div id="password-match" class="text-sm mt-2"></div>
                    </div>

                    <button type="submit" id="update-btn" 
                            class="premium-button w-full text-white px-8 py-4 rounded-xl text-lg font-semibold">
                        <span id="update-btn-text">
                            <i class="fas fa-save mr-3"></i>Update Password
                        </span>
                        <span id="update-btn-loading" class="hidden">
                            <i class="fas fa-spinner fa-spin mr-3"></i>Updating...
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-24 right-6 z-50 space-y-4"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://xvwzpoahmxkqosqkgjvy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2d3pwb2FobXhrcW9zcWtnanZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDk5MDMyMDAsImV4cCI6MjAyNTQ3OTIwMH0.y8Kj9RfX8Q8iI7BZjJm8Rp9L1k6aP5vK2Z8Q3Xj4Y8U';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentEmail = '';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeDarkMode();
            checkResetToken();
            setupFormValidation();
        });

        // Dark mode initialization
        function initializeDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }

        // Check if this is a password reset callback
        function checkResetToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access_token');
            const type = urlParams.get('type');

            if (type === 'recovery' && accessToken) {
                // Show password update form
                document.getElementById('reset-form').classList.add('hidden');
                document.getElementById('success-message').classList.add('hidden');
                document.getElementById('new-password-form').classList.remove('hidden');
            }
        }

        // Form validation setup
        function setupFormValidation() {
            const emailInput = document.getElementById('email');
            if (emailInput) {
                emailInput.addEventListener('blur', validateEmail);
                emailInput.addEventListener('input', clearError.bind(null, 'email'));
            }

            const newPasswordInput = document.getElementById('new_password');
            const confirmPasswordInput = document.getElementById('confirm_password');
            
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', checkPasswordStrength);
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', checkPasswordMatch);
            }
        }

        function validateEmail() {
            const email = document.getElementById('email').value;
            const errorDiv = document.getElementById('email-error');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (email && !emailRegex.test(email)) {
                showFieldError('email', 'Please enter a valid email address');
                return false;
            } else {
                clearError('email');
                return true;
            }
        }

        function showFieldError(fieldId, message) {
            const errorDiv = document.getElementById(fieldId + '-error');
            const inputField = document.getElementById(fieldId);
            
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
            
            if (inputField) {
                inputField.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
            }
        }

        function clearError(fieldId) {
            const errorDiv = document.getElementById(fieldId + '-error');
            const inputField = document.getElementById(fieldId);
            
            if (errorDiv) {
                errorDiv.classList.add('hidden');
            }
            
            if (inputField) {
                inputField.classList.remove('border-red-500', 'bg-red-50', 'dark:bg-red-900/20');
            }
        }

        function togglePasswordVisibility(fieldId) {
            const passwordField = document.getElementById(fieldId);
            const eyeIcon = document.getElementById(fieldId + '-eye');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        }

        function checkPasswordStrength() {
            const password = document.getElementById('new_password').value;
            const strengthBar = document.getElementById('strength-bar');
            const strengthText = document.getElementById('strength-text');
            
            let strength = 0;
            let message = '';
            let requirements = [];
            
            if (password.length >= 8) {
                strength++;
            } else {
                requirements.push('8+ characters');
            }
            
            if (password.match(/[a-z]+/)) {
                strength++;
            } else {
                requirements.push('lowercase letter');
            }
            
            if (password.match(/[A-Z]+/)) {
                strength++;
            } else {
                requirements.push('uppercase letter');
            }
            
            if (password.match(/[0-9]+/)) {
                strength++;
            } else {
                requirements.push('number');
            }
            
            if (password.match(/[$@#&!%*?&]+/)) {
                strength++;
            } else {
                requirements.push('special character');
            }
            
            // Update strength bar
            const percentage = (strength / 5) * 100;
            strengthBar.style.width = `${percentage}%`;
            
            if (strength <= 2) {
                strengthBar.className = 'h-full transition-all duration-300 bg-red-500';
                message = '<span class="text-red-500">Weak password</span>';
            } else if (strength <= 3) {
                strengthBar.className = 'h-full transition-all duration-300 bg-yellow-500';
                message = '<span class="text-yellow-500">Fair password</span>';
            } else if (strength <= 4) {
                strengthBar.className = 'h-full transition-all duration-300 bg-blue-500';
                message = '<span class="text-blue-500">Good password</span>';
            } else {
                strengthBar.className = 'h-full transition-all duration-300 bg-green-500';
                message = '<span class="text-green-500">Strong password</span>';
            }
            
            if (requirements.length > 0) {
                message += ` <span class="text-gray-500">- Missing: ${requirements.join(', ')}</span>`;
            }
            
            strengthText.innerHTML = message;
            
            return strength >= 4;
        }

        function checkPasswordMatch() {
            const password = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const matchDiv = document.getElementById('password-match');
            
            if (confirmPassword.length === 0) {
                matchDiv.innerHTML = '';
                return true;
            }
            
            if (password === confirmPassword) {
                matchDiv.innerHTML = '<span class="text-green-500"><i class="fas fa-check-circle mr-1"></i>Passwords match</span>';
                return true;
            } else {
                matchDiv.innerHTML = '<span class="text-red-500"><i class="fas fa-times-circle mr-1"></i>Passwords do not match</span>';
                return false;
            }
        }

        // Form submissions
        document.getElementById('forgot-password-form')?.addEventListener('submit', handleForgotPassword);
        document.getElementById('update-password-form')?.addEventListener('submit', handleUpdatePassword);

        async function handleForgotPassword(event) {
            event.preventDefault();
            
            if (!validateEmail()) {
                return;
            }
            
            const email = document.getElementById('email').value;
            currentEmail = email;
            
            setLoadingState('reset', true);
            
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: `${window.location.origin}/forgot-password.html`
                });

                if (error) throw error;

                // Show success message
                document.getElementById('reset-form').classList.add('hidden');
                document.getElementById('success-message').classList.remove('hidden');
                document.getElementById('sent-email').textContent = email;

            } catch (error) {
                console.error('Reset password error:', error);
                setLoadingState('reset', false);
                
                let errorMessage = 'Failed to send reset email. Please try again.';
                if (error.message.includes('Invalid email')) {
                    errorMessage = 'Email address not found. Please check and try again.';
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        async function handleUpdatePassword(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            // Validate passwords
            if (!checkPasswordStrength()) {
                showNotification('Password is too weak. Please choose a stronger password.', 'warning');
                return;
            }
            
            if (!checkPasswordMatch()) {
                showNotification('Passwords do not match.', 'error');
                return;
            }
            
            setLoadingState('update', true);
            
            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                showNotification('Password updated successfully!', 'success');
                
                // Redirect to login page
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 2000);

            } catch (error) {
                console.error('Update password error:', error);
                setLoadingState('update', false);
                showNotification('Failed to update password: ' + error.message, 'error');
            }
        }

        async function resendResetEmail() {
            if (!currentEmail) {
                showNotification('Email address not found. Please try again.', 'error');
                return;
            }
            
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(currentEmail, {
                    redirectTo: `${window.location.origin}/forgot-password.html`
                });

                if (error) throw error;

                showNotification('Reset email sent again! Please check your inbox.', 'success');

            } catch (error) {
                showNotification('Failed to resend email: ' + error.message, 'error');
            }
        }

        function setLoadingState(type, loading) {
            const btn = document.getElementById(`${type}-btn`);
            const text = document.getElementById(`${type}-btn-text`);
            const loadingText = document.getElementById(`${type}-btn-loading`);

            if (loading) {
                btn.disabled = true;
                text.classList.add('hidden');
                loadingText.classList.remove('hidden');
            } else {
                btn.disabled = false;
                text.classList.remove('hidden');
                loadingText.classList.add('hidden');
            }
        }

        // Notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            const icons = {
                success: 'fa-check-circle text-green-500',
                error: 'fa-times-circle text-red-500',
                warning: 'fa-exclamation-triangle text-yellow-500',
                info: 'fa-info-circle text-blue-500'
            };
            
            const colors = {
                success: 'bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800 text-green-800 dark:text-green-200',
                error: 'bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800 text-red-800 dark:text-red-200',
                warning: 'bg-yellow-50 dark:bg-yellow-900/30 border-yellow-200 dark:border-yellow-800 text-yellow-800 dark:text-yellow-200',
                info: 'bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200'
            };
            
            notification.className = `p-4 rounded-xl border ${colors[type]} max-w-sm shadow-lg backdrop-blur-sm animate-slide-up`;
            notification.innerHTML = `
                <div class="flex items-start">
                    <i class="fas ${icons[type]} mt-0.5 mr-3 text-lg"></i>
                    <div class="flex-1">
                        <p class="font-medium">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, duration);
        }
    </script>
</body>
</html>